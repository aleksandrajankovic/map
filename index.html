<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mapa uplatnih mesta</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
      :root {
        --sidebar-w: 380px;
        --border: #284755;
        --muted: #6b7280;
        --bg: #16232a;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
      }
      .wrap {
        display: grid;
        grid-template-columns: minmax(260px, var(--sidebar-w)) 1fr;
        min-height: 100vh;
      }
      /* Sidebar */
      .sidebar {
        border-right: 1px solid var(--border);
        padding: 12px;
        background: var(--bg);
        overflow: auto;
      }
      .searchBox {
        position: sticky;
        top: 0;
        background: var(--bg);
        padding-bottom: 8px;
      }
      .searchBox input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--bg);
        color: #e5e7eb;
      }
      .hint {
        color: var(--muted);
        font-size: 12px;
        margin: 6px 2px 10px;
      }

      /* Accordion */
      .acc-item {
        border: 1px solid var(--border);
        border-radius: 10px;
        margin-bottom: 10px;
        overflow: hidden;
      }
      .acc-btn {
        width: 100%;
        text-align: left;
        padding: 12px 14px;
        background: linear-gradient(90deg, #1c2f38 0%, #10181c 100%);
        border: 0;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .acc-btn span {
        font-size: 14px;
        color: var(--muted);
        font-weight: 500;
      }
      .acc-btn div {
        color: #f2f2f2;
      }
      .acc-panel {
        display: none;
        padding: 8px;
      }
      .acc-item.open .acc-panel {
        display: block;
        max-height: 500px;
        overflow-y: scroll;
      }
      .addr {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
      }
      .addr div {
        color: #f2f2f2;
      }

      .addr:hover {
        background: linear-gradient(90deg, #1c2f38 0%, #10181c 100%);
      }
      .addr small {
        color: var(--muted);
      }
      .addr.disabled {
        opacity: 0.5;
        pointer-events: none;
      }
      .badge {
        font-size: 11px;
        background: #eef2ff;
        padding: 2px 6px;
        border-radius: 999px;
      }

      /* Map */
      #map {
        width: 100%;
        height: 100vh;
      }
      #map {
        background: #0b1220;
      } /* fallback dok se tile-ovi učitaju */
      .leaflet-popup-content-wrapper,
      .leaflet-popup-tip {
        background: rgba(17, 24, 39, 0.9);
        color: #e5e7eb;
      }
      .leaflet-control-attribution,
      .leaflet-control-layers {
        background: rgba(17, 24, 39, 0.75);
        color: #e5e7eb;
        backdrop-filter: blur(4px);
      }
      /* Mobile */
      path {
        fill: #73abc1;
      }
      /* lepši skrolbar (opciono) */
      .acc-panel::-webkit-scrollbar {
        width: 10px;
      }
      .acc-panel::-webkit-scrollbar-track {
        background: #16232a;
      }
      .acc-panel::-webkit-scrollbar-thumb {
        background: #233045;
        border-radius: 8px;
      }
      .acc-panel {
        scrollbar-color: #233045 transparent;
        scrollbar-width: thin;
      }
      @media (max-width: 900px) {
        .wrap {
          grid-template-columns: 1fr;
        }
        .sidebar {
          height: 42vh;
        }
        #map {
          height: 58vh;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <aside class="sidebar">
        <div class="searchBox">
          <input
            id="search"
            type="search"
            placeholder="Pretraga adresa/gradova…"
          />
          <!-- <div class="hint">Klikni na <b>grad</b> da otvoriš listu, a zatim na <b>adresu</b> da odeš na pin.</div> -->
        </div>
        <div id="accordion"></div>
      </aside>

      <div id="map"></div>
    </div>

    <script>
      const grouped = {
        Beograd: [
          {
            id: "bg-njegoseva-56",
            title: "Njegoševa 56 (Vračar)",
            lat: 44.801345,
            lng: 20.4721552,
          },
          {
            id: "bg-karadjordjeva-85",
            title: "Karađorđeva 85",
            lat: 44.81,
            lng: 20.4560828,
          },
          {
            id: "bg-ustanicka-182b",
            title: "Ustanička 182b",
            lat: 44.7825524052827,
            lng: 20.506569709437912,
          },
          {
            id: "bg-vojvode-stepe-276",
            title: "Vojvode Stepe 276",
            lat: 44.76863098144531,
            lng: 20.479394912719727,
          },
          {
            id: "bg-gandijeva-5",
            title: "Gandijeva 5",
            lat: 44.81016681469866,
            lng: 20.38348548372806,
          },
          {
            id: "bg-brankova-1",
            title: "Brankova 1",
            lat: 44.81417630518717,
            lng: 20.45697514867069,
          },
          {
            id: "bg-sarajevska-47",
            title: "Sarajevska 47",
            lat: 44.80245216570846,
            lng: 20.45391057420993,
          },
          {
            id: "bg-cvijiceva-36",
            title: "Cvijićeva 36",
            lat: 44.8161108,
            lng: 20.476765,
          },
          {
            id: "bg-cara-dusana-66",
            title: "Cara Dušana 66",
            lat: 44.8215048,
            lng: 20.4630299,
          },
          {
            id: "bg-zorana-radmilovica-4",
            title: "Zorana Radmilovića 4",
            lat: 44.79069324058684,
            lng: 20.539028053486877,
          },
          {
            id: "bg-japanska-4",
            title: "Japanska 4",
            lat: 44.8071444,
            lng: 20.382573,
          },
          {
            id: "bg-visnjicki-venac-1r",
            title: "Višnjički venac 1r",
            lat: 44.81599831621861,
            lng: 20.5323263291476,
          },
          {
            id: "bg-kraljice-marije-10",
            title: "Kraljice Marije 10",
            lat: 44.8084814,
            lng: 20.4760552,
          },
          {
            id: "bg-jurija-gagarina-14dj",
            title: "Jurija Gagarina 14đ",
            lat: 44.805256,
            lng: 20.409187,
          },
          {
            id: "bg-urosa-martinovica-4",
            title: "Uroša Martinovića 4",
            lat: 44.80650529310622,
            lng: 20.401474624641907,
          },
          {
            id: "bg-borca-ivana-milutinovica-75",
            title: "Borča - Ivana Milutinovića 75",
            lat: 44.8763378,
            lng: 20.463467,
          },
          {
            id: "bg-ledine-vojvodjanska-414",
            title: "Ledine - Vojvođanska 414",
            lat: 44.7983863,
            lng: 20.3211546,
          },
        ],
        Zlatibor: [
          {
            id: "zlatibor-centar",
            title: "Zlatibor (centar)",
            lat: 43.8557776,
            lng: 19.8395117,
          },
        ],
        Kraljevo: [
          {
            id: "kraljevo-beogradska-5",
            title: "Beogradska 5",
            lat: 43.7210299,
            lng: 20.692125,
          },
        ],
        "Novi Pazar": [
          {
            id: "novipazar-2",
            title: "Veljka Vlahovića 12a",
            lat: 43.1346086,
            lng: 20.512921,
          },
          {
            id: "novipazar-3",
            title: "Stevana Nemanje 59b",
            lat: 43.1435129,
            lng: 20.5187372,
          },
        ],
        Niš: [
          {
            id: "nis-kalca",
            title: "Obrenovićeva bb",
            lat: 43.3189184,
            lng: 21.8950417,
          },
          {
            id: "nis-novi-bulevar",
            title: "Trg Svetog Save 21g",
            lat: 43.32030040240967,
            lng: 21.91777327453966,
          },
          {
            id: "nis-zeleznicka",
            title: "Železnička",
            lat: 43.3154322,
            lng: 21.8762086,
          },
        ],
        "Novi Sad": [
          {
            id: "ns-sutjeska-2",
            title: "Sutjeska 2",
            lat: 45.24746388307974,
            lng: 19.84563635510584,
          },
          {
            id: "ns-cara-dusana-62",
            title: "Cara Dušana 62",
            lat: 45.2426188560747,
            lng: 19.8250526836245,
          },
        ],
        Kragujevac: [
          {
            id: "kg-centar",
            title: "Kragujevac (centar)",
            lat: 44.0131786,
            lng: 20.9196353,
          },
        ],
        Kruševac: [
          {
            id: "ks-colak-antina-28",
            title: "Čolak Antina 28",
            lat: 43.5815974,
            lng: 21.3294803,
          },
        ],
        Vranje: [
          {
            id: "vranje-centar",
            title: "Vranje (centar)",
            lat: 42.5543511,
            lng: 21.8979003,
          },
        ],
        Ruma: [
          {
            id: "ruma-centar",
            title: "Ruma (centar)",
            lat: 45.00874798956543,
            lng: 19.818571424985745,
          },
        ],
      };

      // 2) MAPA
      const map = L.map("map").setView([44.8176, 20.4569], 6);
      map.createPane("basemap"); 
      map.createPane("tint"); 
      map.createPane("labels"); 

      map.getPane("tint").style.zIndex = 350; 
      map.getPane("tint").style.pointerEvents = "none";

      map.getPane("labels").style.zIndex = 650;
      map.getPane("labels").style.pointerEvents = "none";
      
      const darkBase = L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png",
        {
          pane: "basemap",
          maxZoom: 20,
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> ' +
            'contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        }
      ).addTo(map);

      // --- samo etikete (bele) kao overlay ---
      const darkLabels = L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png",
        { pane: "labels", maxZoom: 20 }
      ).addTo(map);

      // 3) Kreiramo markere + indeks za “skok” na adresu
      const markerById = {};
      const boundsAll = [];

      for (const [city, items] of Object.entries(grouped)) {
        items.forEach((it) => {
          if (it.lat != null && it.lng != null) {
            const m = L.marker([it.lat, it.lng])
              .addTo(map)
              .bindPopup( `<h3>Meridianbet</h3>` +
                `<p>${it.title}</p><p>${city}</p>`
              );
            markerById[it.id] = m;
            boundsAll.push([it.lat, it.lng]);
          }
        });
      }
      if (boundsAll.length) {
        map.fitBounds(boundsAll, { padding: [30, 30] });
      }

      // 4) UI — accordion render
      const accordion = document.getElementById("accordion");
      function countWithCoords(items) {
        return items.filter((x) => x.lat != null && x.lng != null).length;
      }

      for (const [city, items] of Object.entries(grouped)) {
        const hasCoords = countWithCoords(items);
        const item = document.createElement("div");
        item.className = "acc-item";

        const btn = document.createElement("button");
        btn.className = "acc-btn";
        btn.type = "button";
        btn.innerHTML = `<div>${city}</div><span><span class="badge">${hasCoords}/${items.length}</span> ▾</span>`;
        btn.addEventListener("click", () => {
          item.classList.toggle("open");

          // Ako se otvara i ima makar jednu adresu sa koordinatama – fokusiraj mapu na grad
          if (item.classList.contains("open")) {
            const cityPts = items
              .filter((x) => x.lat != null && x.lng != null)
              .map((x) => [x.lat, x.lng]);
            if (cityPts.length) {
              const fg = L.featureGroup(cityPts.map((p) => L.marker(p)));
              map.fitBounds(fg.getBounds(), { padding: [40, 40] });
            }
          }
        });

        const panel = document.createElement("div");
        panel.className = "acc-panel";

        items.forEach((it) => {
          const row = document.createElement("div");
          row.className =
            "addr" + (it.lat == null || it.lng == null ? " disabled" : "");
          row.setAttribute("role", "button");
          row.setAttribute("tabindex", "0");
          row.dataset.addrId = it.id;

          row.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 2C8.14 2 5 5.14 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.86-3.14-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/>
          </svg>
          <div>
            <div>${it.title}</div>
            <small>${
              it.lat != null && it.lng != null
                ? "Klikni za prikaz na mapi"
                : "Nedostaju koordinate"
            }</small>
          </div>
        `;

          // Klik na adresu => flyTo + popup
          const goTo = () => {
            const m = markerById[it.id];
            if (!m) return;
            map.flyTo(m.getLatLng(), 16, { duration: 0.8 });
            setTimeout(() => m.openPopup(), 850);
          };
          if (it.lat != null && it.lng != null) {
            row.addEventListener("click", goTo);
            row.addEventListener("keydown", (e) => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                goTo();
              }
            });
          }

          panel.appendChild(row);
        });

        item.appendChild(btn);
        item.appendChild(panel);
        accordion.appendChild(item);
      }

      // 5) Pretraga (filteruje gradove i adrese)
      const q = document.getElementById("search");
      q.addEventListener("input", () => {
        const term = q.value.trim().toLowerCase();
        [...accordion.children].forEach((block) => {
          const city = block
            .querySelector(".acc-btn div")
            .textContent.toLowerCase();
          const rows = [...block.querySelectorAll(".addr")];

          // Vidljivost adresa po terminu
          let anyVisible = false;
          rows.forEach((r) => {
            const t = r.innerText.toLowerCase();
            const match = city.includes(term) || t.includes(term);
            r.style.display = match ? "" : "none";
            if (match) anyVisible = true;
          });

          // Ako ima poklapanja – prikaži blok, u suprotnom sakrij
          block.style.display = anyVisible ? "" : "none";

          // Ako ima termin i ima poklapanja – automatski otvori blok
          if (term && anyVisible) block.classList.add("open");
          if (
            !term &&
            !block
              .querySelector(".acc-panel .nice-scroll")
              .querySelector('[style*="display: none"]')
          ) {
            // reset UI kad se obriše termin (ne diramo open/close ručno)
          }
        });
      });
    </script>
  </body>
</html>
