<!DOCTYPE html>
<html lang="sr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mapa uplatnih mesta</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
      :root {
        --sidebar-w: 380px;
        --border: #284755;
        --muted: #6b7280;
        --bg: #16232a;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: system-ui, -apple-system, "Roboto", Segoe UI, Arial,
          sans-serif;
        background: #0b1220;
        color: #e5e7eb;
      }

      /* Desktop raspored */
      .wrap {
        display: grid;
        grid-template-columns: minmax(260px, var(--sidebar-w)) 1fr;
        min-height: 100vh;
      }
      .sidebar {
        border-right: 1px solid var(--border);
        padding: 12px;
        background: var(--bg);
        overflow: auto;
      }
      .searchBox {
        position: sticky;
        top: 0;
        background: var(--bg);
        padding-bottom: 8px;
        z-index: 2;
      }
      .searchBox input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--bg);
        color: #e5e7eb;
      }

      /* ---- MOBILNI TABS (vodoravni) ---- */
      .city-tabs {
        display: none;
      } /* desktop sakriveno */
      .city-tab {
        flex: 0 0 150px;
        width: 150px;
        max-width: 150px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid #25364a;

        color: #e5e7eb;
        font-weight: 700;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
        background: linear-gradient(90deg, #1c2f38 0%, #10181c 100%);
      }
      .city-tab.active {
        background: var(--bg);
        border-color: var(--border);
        color: #bdbdbd;
      }

      /* Accordion (desktop) */
      .acc-item {
        border: 1px solid var(--border);
        border-radius: 10px;
        margin-bottom: 10px;
        overflow: hidden;
      }
      .acc-btn {
        width: 100%;
        text-align: left;
        padding: 12px 14px;
        background: linear-gradient(90deg, #1c2f38 0%, #10181c 100%);
        border: 0;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #f2f2f2;
      }
      .acc-btn span {
        font-size: 14px;
        color: var(--muted);
        font-weight: 500;
      }
      .acc-panel {
        display: none;
        padding: 8px;
      }
      .acc-item.open .acc-panel {
        display: block;
        max-height: 500px;
        overflow-y: auto;
      }

      .addr {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
      }
      .addr:hover {
        background: linear-gradient(90deg, #1c2f38 0%, #10181c 100%);
      }
      .addr small {
        color: var(--muted);
      }
      .addr div {
        color: #f2f2f2;
      }
      .addr.disabled {
        opacity: 0.5;
        pointer-events: none;
      }
      .badge {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 999px;
      }
      .acc-panel::-webkit-scrollbar {
        width: 10px;
      }
      .acc-panel::-webkit-scrollbar-track {
        background: #16232a;
      }
      .acc-panel::-webkit-scrollbar-thumb {
        background: #233045;
        border-radius: 8px;
      }
      .acc-panel {
        scrollbar-color: #233045 transparent;
        scrollbar-width: thin;
      }

      /* Mapa */
      #map {
        width: 100%;
        height: 100vh;
        background: #0b1220;
      }
      .leaflet-popup-content-wrapper,
      .leaflet-popup-tip {
        background: #16232a;
        color: #e5e7eb;
        border: 1px solid #396f85;
      }
      .leaflet-control-attribution,
      .leaflet-control-layers {
        background: rgba(17, 24, 39, 0.75);
        color: #e5e7eb;
        backdrop-filter: blur(4px);
      }
      .leaflet-pane.leaflet-popup-pane {
        z-index: 1000 !important;
      }
      .leaflet-popup-content {
        width: 200px !important;
        height: 100px !important;
      }
      .leaflet-popup-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
        font-family: "Roboto", sans-serif;
        gap: 5px;
      }
      .leaflet-popup-content h3 {
        font-size: 20px;
      }
      .leaflet-popup-content p {
        font-size: 14px;
        color: #bdbdbd;
        margin: 0px !important;
        padding-top: 6px;
      }
      .pin-icon {
        fill: #73abc1;
      }
      .leaflet-control-attribution {
        font-size: 12px;
        padding: 2px 6px;
        border-radius: 6px;
        background: transparent !important;
        color: #e5e7eb;
      }
      /* ===== RESPONSIVE ===== */
      @media (max-width: 900px) {
        html,
        body {
          overflow-x: hidden;
        }

        .wrap {
          grid-template-columns: 1fr;
          grid-template-rows: auto minmax(0, 1fr);
          min-height: 100svh;
        }

        .sidebar {
          border-right: none;
          border-bottom: 1px solid var(--border);
          padding: 0; /* <— važno */
          overflow: visible;
          height: auto;
        }

        .searchBox,
        .city-tabs {
          width: 100svw;
          margin-left: 50%;
          transform: translateX(-50%);
          padding: 12px;
        }

        .searchBox {
          padding-bottom: 8px;
        }
        .searchBox input {
          width: 100%;
          border-radius: 10px;
        }

        .city-tabs {
          display: flex;
          gap: 8px;
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          padding-top: 6px;
          padding-bottom: 10px;
        }
        .city-tabs::-webkit-scrollbar {
          display: none;
        }

        .city-tab {
          flex: 0 0 150px;
          width: 150px;
          max-width: 150px;
          white-space: nowrap;
        }

        .acc-btn {
          display: none;
        }
        .acc-item {
          border: none;
          margin: 0;
          background: transparent;
        }
        .sidebar:not(.expanded) .acc-panel {
          display: none !important;
        }
        .sidebar.expanded .acc-item.open .acc-panel {
          display: block;
          max-height: 50vh;
          overflow: auto;
        }

        #map {
          height: auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <aside class="sidebar" id="sidebar">
        <div class="searchBox">
          <input
            id="search"
            type="search"
            placeholder="Pretraga adresa/gradova…"
          />
        </div>

        <!-- Tabs (mobilni) -->
        <div id="mobileTabs" class="city-tabs" aria-label="Gradovi"></div>

        <!-- Accordion (desktop) + paneli (mobilni) -->
        <div id="accordion"></div>
      </aside>

      <div id="map"></div>
    </div>

    <script>
      /* ===== Custom pin ===== */
      const myIcon = L.icon({
        iconUrl: "./meridianbet-pin.png",
        iconRetinaUrl: "./meridianbet-pin.png",
        iconSize: [30, 42],
        iconAnchor: [15, 42],
        popupAnchor: [0, -38],
      });

      /* ===== PODACI ===== */
      const grouped = {
        Beograd: [
          {
            id: "bg-njegoseva-56",
            title: "Njegoševa 56 (Vračar)",
            lat: 44.801345,
            lng: 20.4721552,
          },
          {
            id: "bg-karadjordjeva-85",
            title: "Karađorđeva 85",
            lat: 44.81,
            lng: 20.4560828,
          },
          {
            id: "bg-ustanicka-182b",
            title: "Ustanička 182b",
            lat: 44.7825524052827,
            lng: 20.506569709437912,
          },
          {
            id: "bg-vojvode-stepe-276",
            title: "Vojvode Stepe 276",
            lat: 44.76863098144531,
            lng: 20.479394912719727,
          },
          {
            id: "bg-gandijeva-5",
            title: "Gandijeva 5",
            lat: 44.81016681469866,
            lng: 20.38348548372806,
          },
          {
            id: "bg-brankova-1",
            title: "Brankova 1",
            lat: 44.81417630518717,
            lng: 20.45697514867069,
          },
          {
            id: "bg-sarajevska-47",
            title: "Sarajevska 47",
            lat: 44.80245216570846,
            lng: 20.45391057420993,
          },
          {
            id: "bg-cvijiceva-36",
            title: "Cvijićeva 36",
            lat: 44.8161108,
            lng: 20.476765,
          },
          {
            id: "bg-cara-dusana-66",
            title: "Cara Dušana 66",
            lat: 44.8215048,
            lng: 20.4630299,
          },
          {
            id: "bg-zorana-radmilovica-4",
            title: "Zorana Radmilovića 4",
            lat: 44.79069324058684,
            lng: 20.539028053486877,
          },
          {
            id: "bg-japanska-4",
            title: "Japanska 4",
            lat: 44.8071444,
            lng: 20.382573,
          },
          {
            id: "bg-visnjicki-venac-1r",
            title: "Višnjički venac 1r",
            lat: 44.81599831621861,
            lng: 20.5323263291476,
          },
          {
            id: "bg-kraljice-marije-10",
            title: "Kraljice Marije 10",
            lat: 44.8084814,
            lng: 20.4760552,
          },
          {
            id: "bg-jurija-gagarina-14dj",
            title: "Jurija Gagarina 14đ",
            lat: 44.805256,
            lng: 20.409187,
          },
          {
            id: "bg-urosa-martinovica-4",
            title: "Uroša Martinovića 4",
            lat: 44.80650529310622,
            lng: 20.401474624641907,
          },
          {
            id: "bg-borca-ivana-milutinovica-75",
            title: "Borča - Ivana Milutinovića 75",
            lat: 44.8763378,
            lng: 20.463467,
          },
          {
            id: "bg-ledine-vojvodjanska-414",
            title: "Ledine - Vojvođanska 414",
            lat: 44.7983863,
            lng: 20.3211546,
          },
        ],
        Zlatibor: [
          {
            id: "zlatibor-centar",
            title: "Miladina Pećinara 119",
            lat: 43.72611442864385,
            lng: 19.696825584412423,
          },
        ],
        Kraljevo: [
          {
            id: "kraljevo-beogradska-5",
            title: "Beogradska 5",
            lat: 43.7210299,
            lng: 20.692125,
          },
        ],
        "Novi Pazar": [
          {
            id: "novipazar-2",
            title: "Veljka Vlahovića 12a",
            lat: 43.1346086,
            lng: 20.512921,
          },
          {
            id: "novipazar-3",
            title: "Stevana Nemanje 59b",
            lat: 43.1435129,
            lng: 20.5187372,
          },
        ],
        Niš: [
          {
            id: "nis-kalca",
            title: "Obrenovićeva bb",
            lat: 43.3189184,
            lng: 21.8950417,
          },
          {
            id: "nis-novi-bulevar",
            title: "Trg Svetog Save 21g",
            lat: 43.32030040240967,
            lng: 21.91777327453966,
          },
          {
            id: "nis-zeleznicka",
            title: "Železnička",
            lat: 43.3154322,
            lng: 21.8762086,
          },
        ],
        "Novi Sad": [
          {
            id: "ns-sutjeska-2",
            title: "Sutjeska 2",
            lat: 45.24746388307974,
            lng: 19.84563635510584,
          },
          {
            id: "ns-cara-dusana-62",
            title: "Cara Dušana 62",
            lat: 45.2426188560747,
            lng: 19.8250526836245,
          },
        ],
        Kragujevac: [
          {
            id: "kg-centar",
            title: "Aleksandra Saše Čančarevića 1",
            lat: 44.01403092529991,
            lng: 20.897043850434745,
          },
        ],
        Kruševac: [
          {
            id: "ks-colak-antina-28",
            title: "Čolak Antina 28",
            lat: 43.5815974,
            lng: 21.3294803,
          },
        ],
        Vranje: [
          {
            id: "vranje-centar",
            title: "Beogradska 39a",
            lat: 42.55158156904805,
            lng: 21.89686853897778,
          },
        ],
        Ruma: [
          {
            id: "ruma-centar",
            title: "Glavna 164",
            lat: 45.00803756402931,
            lng: 19.82114866827308,
          },
        ],
      };

      /* ===== Mapa ===== */
      const map = L.map("map").setView([44.8176, 20.4569], 6);
      map.attributionControl.setPosition("bottomright");
      map.attributionControl.setPrefix(false);
      map.createPane("basemap");
      map.createPane("labels");
      map.createPane("markers");
      map.getPane("labels").style.zIndex = 650;
      map.getPane("labels").style.pointerEvents = "none";
      map.getPane("markers").style.zIndex = 660;

      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png",
        {
          pane: "basemap",
          maxZoom: 20,
          attribution: "&copy; OpenStreetMap contributors &copy; CARTO",
        }
      ).addTo(map);
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png",
        { pane: "labels", maxZoom: 20 }
      ).addTo(map);

      /* Markeri + indeks */
      const markerById = {};
      const boundsAll = [];
      for (const [city, items] of Object.entries(grouped)) {
        items.forEach((it) => {
          if (it.lat != null && it.lng != null) {
            const m = L.marker([it.lat, it.lng], {
              icon: myIcon,
              pane: "markers",
            }).addTo(map)
              .bindPopup(`<h3 style="margin:.25rem 0">Meridianbet</h3>
                <span style="display:flex;align-items:center;gap:8px"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M12 21s-7-6.5-7-12a7 7 0 0 1 14 0c0 5.5-7 12-7 12z" fill="none" stroke="#73abc1" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="9.75" r="2.75" fill="none" stroke="#73abc1" stroke-width="1.8"/></svg>${it.title}</span>
                <span style="display:flex;align-items:center;gap:8px;opacity:.85"><svg width="18" height="18" viewBox="0 0 24 24"><path d="M3 21h18M5 21V13h3v8M10 21V7h3v14M15 21V10h4v11" fill="none" stroke="#73abc1" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>${city}</span>`);
            markerById[it.id] = m;
            boundsAll.push([it.lat, it.lng]);
          }
        });
      }
      if (boundsAll.length) map.fitBounds(boundsAll, { padding: [30, 30] });

      /* ===== Accordion + Tabs ===== */
      const accordion = document.getElementById("accordion");
      const tabsWrap = document.getElementById("mobileTabs");
      const sidebar = document.getElementById("sidebar");

      const countWithCoords = (items) =>
        items.filter((x) => x.lat != null && x.lng != null).length;

      // Render accordion (desktop)
      for (const [city, items] of Object.entries(grouped)) {
        const hasCoords = countWithCoords(items);

        const item = document.createElement("div");
        item.className = "acc-item";
        item.dataset.city = city;

        const btn = document.createElement("button");
        btn.className = "acc-btn";
        btn.type = "button";
        btn.innerHTML = `<div>${city}</div><span><span class="badge">${hasCoords}/${items.length}</span> ▾</span>`;
        btn.addEventListener("click", () => {
          item.classList.toggle("open");
          if (item.classList.contains("open")) {
            const pts = items
              .filter((x) => x.lat != null && x.lng != null)
              .map((x) => [x.lat, x.lng]);
            if (pts.length) {
              const fg = L.featureGroup(pts.map((p) => L.marker(p)));
              map.fitBounds(fg.getBounds(), { padding: [40, 40] });
            }
          }
        });

        const panel = document.createElement("div");
        panel.className = "acc-panel";

        items.forEach((it) => {
          const row = document.createElement("div");
          row.className =
            "addr" + (it.lat == null || it.lng == null ? " disabled" : "");
          row.setAttribute("role", "button");
          row.setAttribute("tabindex", "0");
          row.dataset.addrId = it.id;
          row.innerHTML = `
            <svg class="pin-icon" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M12 2C8.14 2 5 5.14 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.86-3.14-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/>
            </svg>
            <div>
              <div>${it.title}</div>
              <small>${
                it.lat != null && it.lng != null
                  ? "Klikni za prikaz na mapi"
                  : "Nedostaju koordinate"
              }</small>
            </div>`;
          const goTo = () => {
            const m = markerById[it.id];
            if (!m) return;

            // skok na marker
            map.flyTo(m.getLatLng(), 16, { duration: 0.8 });

            // otvori popup i (na mobilu) sklopi listu
            setTimeout(() => {
              m.openPopup();

              // samo na mobilu (<= 900px)
              if (window.matchMedia("(max-width: 900px)").matches) {
                // skloni proširenje sidebara
                sidebar.classList.remove("expanded");
                // zatvori sve otvorene panele u accordionu
                document
                  .querySelectorAll("#accordion .acc-item.open")
                  .forEach((el) => el.classList.remove("open"));
              }
            }, 850); // možeš smanjiti na 300ms ako želiš brže
          };
          if (it.lat != null && it.lng != null) {
            row.addEventListener("click", goTo);
            row.addEventListener("keydown", (e) => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                goTo();
              }
            });
          }
          panel.appendChild(row);
        });

        item.appendChild(btn);
        item.appendChild(panel);
        accordion.appendChild(item);
      }

      // Render mobilnih tabova
      for (const city of Object.keys(grouped)) {
        const tab = document.createElement("button");
        tab.type = "button";
        tab.className = "city-tab";
        tab.textContent = city;

        tab.addEventListener("click", () => {
          const target = [...accordion.children].find(
            (el) => el.dataset.city === city
          );
          const alreadyOpen =
            target?.classList.contains("open") &&
            sidebar.classList.contains("expanded") &&
            tab.classList.contains("active");

          if (alreadyOpen) {
            sidebar.classList.remove("expanded");
            tab.classList.remove("active");
            [...accordion.children].forEach((el) =>
              el.classList.remove("open")
            );
            return;
          }

          [...tabsWrap.children].forEach((x) => x.classList.remove("active"));
          tab.classList.add("active");
          sidebar.classList.add("expanded");
          [...accordion.children].forEach((el) => el.classList.remove("open"));
          if (target) target.classList.add("open");

          const pts = grouped[city]
            .filter((x) => x.lat != null && x.lng != null)
            .map((x) => [x.lat, x.lng]);
          if (pts.length) {
            const fg = L.featureGroup(pts.map((p) => L.marker(p)));
            map.fitBounds(fg.getBounds(), { padding: [40, 40] });
          }
        });

        tabsWrap.appendChild(tab);
      }
      if (tabsWrap.firstElementChild)
        tabsWrap.firstElementChild.classList.add("active");

      /* ===== Pretraga ===== */
      const q = document.getElementById("search");
      q.addEventListener("input", () => {
        const term = q.value.trim().toLowerCase();

        // Ako se nešto traži na mobilu – otvori sidebar da bi se videli rezultati
        if (term && window.matchMedia("(max-width: 900px)").matches) {
          document.getElementById("sidebar").classList.add("expanded");
        }

        [...accordion.children].forEach((block) => {
          const city = (block.dataset.city || "").toLowerCase();
          const rows = [...block.querySelectorAll(".addr")];
          let anyVisible = false;

          rows.forEach((r) => {
            const t = r.innerText.toLowerCase();
            const match = city.includes(term) || t.includes(term);
            r.style.display = match ? "" : "none";
            if (match) anyVisible = true;
          });

          block.style.display = anyVisible ? "" : "none";
          if (term && anyVisible) block.classList.add("open");
        });
      });
    </script>
  </body>
</html>
